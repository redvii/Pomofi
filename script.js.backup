class LofiTimer {
    constructor() {
        this.workTime = 25 * 60; // 25 minutes in seconds
        this.breakTime = 5 * 60; // 5 minutes in seconds
        this.longBreakTime = 15 * 60; // 15 minutes in seconds
        this.currentTime = this.workTime;
        this.isRunning = false;
        this.isWorkTime = true;
        this.sessionCount = 0;
        this.timer = null;
        this.circumference = 2 * Math.PI * 140; // For progress ring
        
        this.initializeElements();
        this.setupEventListeners();
        this.updateDisplay();
        this.setupAudio();
    }

    initializeElements() {
        this.timeDisplay = document.getElementById('time-display');
        this.startBtn = document.getElementById('start-btn');
        this.pauseBtn = document.getElementById('pause-btn');
        this.resetBtn = document.getElementById('reset-btn');
        this.sessionCountElement = document.getElementById('session-count');
        this.modeIndicator = document.getElementById('mode-indicator');
        this.progressCircle = document.querySelector('.progress-ring-circle');
        this.audio = document.getElementById('lofi-audio');
        this.volumeSlider = document.getElementById('volume-slider');
        this.volumeIcon = document.getElementById('volume-icon');
        this.musicTitle = document.getElementById('music-title');
    }

    setupEventListeners() {
        this.startBtn.addEventListener('click', () => this.startTimer());
        this.pauseBtn.addEventListener('click', () => this.pauseTimer());
        this.resetBtn.addEventListener('click', () => this.resetTimer());
        
        // Background switching
        document.querySelectorAll('.bg-option').forEach(option => {
            option.addEventListener('click', (e) => this.switchBackground(e.target.closest('.bg-option').dataset.bg));
        });

        // Volume control
        this.volumeSlider.addEventListener('input', (e) => this.setVolume(e.target.value));
        this.volumeIcon.addEventListener('click', () => this.toggleMute());
    }

    setupAudio() {
        // Set up lofi music with multiple sources for better compatibility
        const audioSources = [
    "https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3?filename=lofi-study-112191.mp3",
    "https://cdn.pixabay.com/download/audio/2022/10/21/audio_2b228b709b.mp3?filename=lofi-relax-travel-by-lofium-123560.mp3",
    "https://cdn.pixabay.com/download/audio/2024/08/13/audio_cc7e9a45a5.mp3?filename=velvet-sky-lofi-ambient-231924.mp3"
        ];

        // Create audio context for better audio handling
        this.audioContext = null;
        this.audioSource = null;
        
        // Set initial volume
        this.audio.volume = this.volumeSlider.value / 100;
        
        // Handle audio loading
        this.audio.addEventListener('canplaythrough', () => {
            console.log('Audio loaded successfully');
        });
        
        this.audio.addEventListener('error', (e) => {
            console.log('Audio error:', e);
        });
    }

    startTimer() {
        if (!this.isRunning) {
            this.isRunning = true;
            this.startBtn.style.display = 'none';
            this.pauseBtn.style.display = 'flex';
            
            // Start playing lofi music
            this.playMusic();
            
            this.timer = setInterval(() => {
                this.currentTime--;
                this.updateDisplay();
                
                if (this.currentTime <= 0) {
                    this.completeSession();
                }
            }, 1000);
        }
    }

    pauseTimer() {
        if (this.isRunning) {
            this.isRunning = false;
            this.startBtn.style.display = 'flex';
            this.pauseBtn.style.display = 'none';
            
            // Pause music
            this.pauseMusic();
            
            clearInterval(this.timer);
        }
    }

    resetTimer() {
        this.pauseTimer();
        this.currentTime = this.workTime;
        this.isWorkTime = true;
        this.sessionCount = 0;
        this.updateDisplay();
        this.updateModeIndicator();
        this.updateSessionCount();
    }

    completeSession() {
        this.pauseTimer();
        
        if (this.isWorkTime) {
            this.sessionCount++;
            this.updateSessionCount();
            
            // Show completion notification
            this.showNotification('Work session completed! Take a break.');
            
            // Switch to break time
            if (this.sessionCount % 4 === 0) {
                this.currentTime = this.longBreakTime;
                this.modeIndicator.textContent = 'Long Break';
            } else {
                this.currentTime = this.breakTime;
                this.modeIndicator.textContent = 'Short Break';
            }
            this.isWorkTime = false;
        } else {
            // Break completed, back to work
            this.currentTime = this.workTime;
            this.isWorkTime = true;
            this.modeIndicator.textContent = 'Work Time';
            this.showNotification('Break completed! Time to focus.');
        }
        
        this.updateDisplay();
        this.updateModeIndicator();
        
        // Add completion animation
        this.timeDisplay.classList.add('timer-complete');
        setTimeout(() => {
            this.timeDisplay.classList.remove('timer-complete');
        }, 500);
    }

    updateDisplay() {
        const minutes = Math.floor(this.currentTime / 60);
        const seconds = this.currentTime % 60;
        this.timeDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update progress ring
        this.updateProgressRing();
    }

    updateProgressRing() {
        const totalTime = this.isWorkTime ? this.workTime : (this.sessionCount % 4 === 0 ? this.longBreakTime : this.breakTime);
        const progress = 1 - (this.currentTime / totalTime);
        const offset = this.circumference - (progress * this.circumference);
        
        this.progressCircle.style.strokeDashoffset = offset;
    }

    updateSessionCount() {
        this.sessionCountElement.textContent = this.sessionCount;
    }

    updateModeIndicator() {
        if (this.isWorkTime) {
            this.modeIndicator.textContent = 'Work Time';
        } else if (this.sessionCount % 4 === 0) {
            this.modeIndicator.textContent = 'Long Break';
        } else {
            this.modeIndicator.textContent = 'Short Break';
        }
    }

    switchBackground(backgroundId) {
        // Remove active class from all backgrounds
        document.querySelectorAll('.background').forEach(bg => {
            bg.classList.remove('active');
        });
        
        // Add active class to selected background
        document.getElementById(backgroundId).classList.add('active');
        
        // Update button states
        document.querySelectorAll('.bg-option').forEach(option => {
            option.classList.remove('active');
        });
        
        document.querySelector(`[data-bg="${backgroundId}"]`).classList.add('active');
    }

    playMusic() {
        if (this.audio.readyState >= 2) { // HAVE_CURRENT_DATA or higher
            this.audio.play().catch(e => {
                console.log('Audio play failed:', e);
            });
        }
    }

    pauseMusic() {
        this.audio.pause();
    }

    setVolume(value) {
        const volume = value / 100;
        this.audio.volume = volume;
        
        // Update volume icon
        if (volume === 0) {
            this.volumeIcon.className = 'fas fa-volume-mute';
        } else if (volume < 0.5) {
            this.volumeIcon.className = 'fas fa-volume-down';
        } else {
            this.volumeIcon.className = 'fas fa-volume-up';
        }
    }

    toggleMute() {
        if (this.audio.volume > 0) {
            this.lastVolume = this.audio.volume;
            this.audio.volume = 0;
            this.volumeSlider.value = 0;
            this.volumeIcon.className = 'fas fa-volume-mute';
        } else {
            this.audio.volume = this.lastVolume || 0.5;
            this.volumeSlider.value = this.audio.volume * 100;
            this.setVolume(this.volumeSlider.value);
        }
    }

    showNotification(message) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    const lofiTimer = new LofiTimer();
    
    // Add some additional rain/snow particles for more dynamic backgrounds
    function addParticles() {
        const backgrounds = document.querySelectorAll('.background');
        
        backgrounds.forEach(bg => {
            if (bg.classList.contains('rain-bg')) {
                for (let i = 0; i < 20; i++) {
                    const rain = document.createElement('div');
                    rain.className = 'rain';
                    rain.style.left = Math.random() * 100 + '%';
                    rain.style.animationDuration = (Math.random() * 1 + 1) + 's';
                    rain.style.animationDelay = Math.random() * 2 + 's';
                    bg.appendChild(rain);
                }
            } else if (bg.classList.contains('snow-bg')) {
                for (let i = 0; i < 15; i++) {
                    const snow = document.createElement('div');
                    snow.className = 'snow';
                    snow.style.left = Math.random() * 100 + '%';
                    snow.style.animationDuration = (Math.random() * 4 + 8) + 's';
                    snow.style.animationDelay = Math.random() * 5 + 's';
                    bg.appendChild(snow);
                }
            }
        });
    }
    
    // Add particles after a short delay
    setTimeout(addParticles, 1000);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space') {
            e.preventDefault();
            if (lofiTimer.isRunning) {
                lofiTimer.pauseTimer();
            } else {
                lofiTimer.startTimer();
            }
        } else if (e.code === 'KeyR') {
            lofiTimer.resetTimer();
        }
    });
    
    // Add service worker for PWA capabilities (optional)
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    }
});

// Add some ambient sound effects for better immersion
class AmbientSounds {
    constructor() {
        this.audioContext = null;
        this.rainSound = null;
        this.cafeSound = null;
    }

    init() {
        if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
            this.audioContext = new (AudioContext || webkitAudioContext)();
        }
    }

    createRainSound() {
        if (!this.audioContext) return;
        
        const bufferSize = this.audioContext.sampleRate * 2;
        const buffer = this.audioContext.createBuffer(1, bufferSize, this.audioContext.sampleRate);
        const output = buffer.getChannelData(0);
        
        for (let i = 0; i < bufferSize; i++) {
            output[i] = Math.random() * 2 - 1;
        }
        
        this.rainSound = this.audioContext.createBufferSource();
        this.rainSound.buffer = buffer;
        this.rainSound.loop = true;
        
        const gainNode = this.audioContext.createGain();
        gainNode.gain.value = 0.1;
        
        this.rainSound.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
    }

    playRain() {
        if (this.rainSound) {
            this.rainSound.start();
        }
    }

    stopRain() {
        if (this.rainSound) {
            this.rainSound.stop();
        }
    }
}

// Initialize ambient sounds
const ambientSounds = new AmbientSounds();
document.addEventListener('DOMContentLoaded', () => {
    ambientSounds.init();
});
